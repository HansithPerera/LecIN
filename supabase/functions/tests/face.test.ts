// Import required libraries and modules
import { assert } from "jsr:@std/assert@1";
import { SupabaseClient } from "npm:@supabase/supabase-js@2"; // Will load the .env file to Deno.env
import "jsr:@std/dotenv/load";
import { v4 as uuidv4 } from "uuid";
import { getAnonClient, getServiceRoleClient } from "../_shared/auth.ts";

const testCheckInCameraWithBadApiKey = async () => {
  const client: SupabaseClient = await getAnonClient();

  const resp = await client.functions.invoke("camera-check-in", {
    method: "POST",
    headers: {
      "apikey": "bad-api-key",
    },
  });
  assert(resp.error);
};

const testCheckInCameraWithMissingApiKey = async () => {
  const client: SupabaseClient = await getAnonClient();

  const resp = await client.functions.invoke("camera-check-in", {
    method: "POST",
  });
  assert(resp.error);
};

const testCheckInCameraFail = async () => {
  const client: SupabaseClient = await getServiceRoleClient();

  const locationId = uuidv4();
  const { data: newLocationData, error: newLocationError } = await client
    .from("Locations")
    .upsert({
      Id: locationId,
      Room: "101",
      Level: "1",
      Building: "Main",
      Coords: "POINT(-122.4194 37.7749)",
    });

  assert(
    !newLocationError,
    "Failed to insert new location: " + newLocationError?.message,
  );

  const { data: newCameraData, error: newCameraError } = await client
    .from("Cameras")
    .insert({ Name: "Test Camera", Location: locationId, IsActive: true })
    .select()
    .single();

  assert(
    !newCameraError,
    "Failed to insert new camera: " + newCameraError?.message,
  );

  const create_key_resp = await client.functions.invoke(
    "create-camera-api-key",
    {
      method: "POST",
      body: JSON.stringify({
        CameraId: newCameraData.Id,
        Primary: true,
      }),
    },
  );

  assert(
    !create_key_resp.error,
    "Failed to create camera API key: " + JSON.stringify(create_key_resp.error),
  );
  const key: string = await create_key_resp.data.Key;

  assert(key.length > 0, "No API key returned from create-camera-api-key");

  const anonClient: SupabaseClient = await getAnonClient();

  const resp = await anonClient.functions.invoke("camera-check-in", {
    method: "POST",
    headers: {
      "apikey": key,
    },
    body: JSON.stringify({
      Embedding: [
        -0.038010236,
        0.057701565,
        0.0036352957,
        -0.024159303,
        0.027108332,
        0.048162226,
        -0.033047274,
        0.02347423,
        0.054562975,
        -0.0071631623,
        -0.01420961,
        -0.009219882,
        -0.062147893,
        0.12868369,
        -0.011576524,
        -0.030785693,
        0.028931249,
        -0.009886717,
        0.035652213,
        0.058706142,
        0.008558345,
        0.035236865,
        -0.051164046,
        0.08741287,
        -0.107769415,
        0.018581828,
        0.0054287966,
        -0.04033806,
        0.03474322,
        0.04706778,
        -0.059890676,
        -0.012678692,
        -0.0029881783,
        0.010636661,
        0.03166493,
        -0.017627722,
        -0.03679362,
        -0.042835154,
        0.030940464,
        0.025954833,
        -0.06992266,
        -0.035254065,
        -0.012297381,
        -0.03327603,
        -0.08605423,
        0.079808965,
        0.052524775,
        -0.026504334,
        -0.01632659,
        -0.0323103,
        0.053850897,
        -0.021101348,
        -0.033268325,
        -0.008140734,
        0.023700586,
        0.047294624,
        -0.01965913,
        0.04035297,
        -0.047497857,
        0.084437706,
        -3.3430282E-05,
        0.021488804,
        -0.039809663,
        -0.0034467257,
        0.0043009273,
        0.029519921,
        -0.0021182005,
        0.005033458,
        0.0018995111,
        -0.004956566,
        0.03783719,
        0.020556526,
        0.09986405,
        -0.011085955,
        -0.021925978,
        0.052706253,
        -0.058268607,
        0.079927474,
        0.028679583,
        0.033251155,
        0.05618271,
        -0.043209516,
        0.050102662,
        0.038724396,
        -0.030359276,
        0.064896,
        -0.017765248,
        0.008533326,
        -0.057222813,
        0.025562078,
        0.08275278,
        0.031167125,
        -0.046310168,
        -0.08169419,
        -0.029032735,
        -0.0712762,
        0.052131012,
        -0.048893828,
        -0.014940194,
        -0.0075892746,
        0.0500024,
        0.031249538,
        0.06954609,
        -0.043138083,
        0.050779764,
        -0.06866145,
        0.056563813,
        -0.0069472496,
        0.061027937,
        0.0020909235,
        0.13505895,
        -0.022720555,
        0.056093533,
        0.07661903,
        -0.017961493,
        -0.0056311903,
        0.01862366,
        -0.0070199575,
        -0.060333755,
        -0.031860735,
        -0.0035364216,
        0.035570968,
        0.0052810055,
        -0.054315574,
        0.02374411,
        -0.06983651,
        -0.0821384,
        0.031199584,
        0.049306095,
        0.006790535,
        -0.020474972,
        0.0018671815,
        -0.013107261,
        -0.026397793,
        0.061746117,
        -0.038489107,
        0.0024295659,
        0.028404083,
        0.07795688,
        0.09316251,
        0.026773235,
        0.014249191,
        0.03361728,
        0.01680751,
        0.09190739,
        0.0075230966,
        0.014379702,
        0.040794414,
        -0.008540728,
        0.03659538,
        -0.03437147,
        -0.024163509,
        -0.03653062,
        -0.05477823,
        -0.019248249,
        -0.023699025,
        0.033891167,
        -0.022553071,
        -0.031669695,
        -0.07026198,
        -0.048941605,
        -0.052484542,
        -0.0780771,
        0.031306654,
        0.0057063857,
        -0.0072345687,
        -0.0062303795,
        -0.02205635,
        -0.079087056,
        -0.017302984,
        -0.021467334,
        0.026903039,
        -0.016634647,
        0.049458753,
        -0.014336004,
        -0.035915054,
        -0.013078753,
        -0.05117912,
        0.023716481,
        0.00722005,
        0.025752954,
        -0.09103255,
        0.036741264,
        6.282166E-06,
        -0.06340545,
        -0.040792473,
        -0.03638987,
        -0.0045975703,
        0.08892192,
        -0.058959324,
        -0.06964175,
        0.08242747,
        0.03151705,
        0.004658187,
        0.03120655,
        0.07202596,
        0.037236337,
        -0.027396211,
        -0.02689465,
        -0.028508853,
        0.050761092,
        0.020554187,
        0.027090667,
        -0.011573774,
        0.072357565,
        -0.026442036,
        -0.033248108,
        0.008502204,
        0.050759092,
        0.006017217,
        -0.028589614,
        -0.019462794,
        0.014398748,
        -0.01629446,
        -0.04605316,
        -0.10098294,
        0.00810945,
        0.06545348,
        0.043847613,
        -0.015898323,
        0.09707134,
        0.023745606,
        0.0077405577,
        0.010965405,
        -0.0068784608,
        0.0742118,
        -0.052916355,
        0.025523933,
        0.04681,
        -0.01668626,
        -0.026804172,
        0.019676127,
        -0.072589554,
        0.0699062,
        -0.049086154,
        -0.107996605,
        0.06771768,
        0.0043233703,
        -0.01466586,
        -0.011573371,
        0.019073134,
        0.028873557,
        0.035955027,
        0.025799116,
        0.021974443,
        0.0025637248,
        0.019478707,
        0.017689923,
        -0.037487388,
        -0.035569247,
        0.015648436,
        -0.023539647,
        0.03534221,
        -0.008497897,
        -0.01366886,
        -0.1140271,
        0.048428096,
        0.06382529,
        0.020374212,
        0.0033394645,
        -0.004775112,
        -0.051325377,
        0.08492222,
        0.0665426,
        -0.045804676,
        -0.045872036,
        -0.07888869,
        -0.10101964,
        -0.05744672,
        0.044797037,
        -0.014665793,
        0.03559079,
        -0.022392621,
        0.045858927,
        0.05016647,
        0.05812303,
        -0.1146568,
        0.014976921,
        -0.0074426644,
        -0.04760891,
        -0.0051037464,
        0.01853322,
        0.04223576,
        -0.072584055,
        0.017294278,
        0.026242703,
        0.059511576,
        -0.057476554,
        -0.036703017,
        -0.07673707,
        -0.03523201,
        0.0073126727,
        0.06136731,
        -0.09713408,
        -0.023454377,
        0.015753651,
        0.02766996,
        0.018571341,
        -0.030867796,
        0.007117114,
        -0.037267257,
        -0.062538214,
        0.041729644,
        -0.060649402,
        -0.04916898,
        -0.0031098605,
        -0.0086564645,
        0.038776934,
        -0.00061752985,
        0.03733204,
        0.05299887,
        0.044926777,
        0.002674963,
        -0.004930037,
        -0.0746934,
        -0.004041477,
        -0.050806142,
        0.063353874,
        0.014858844,
        0.07220639,
        0.034105483,
        -0.039419252,
        -0.013769348,
        0.045766395,
        -0.018073682,
        0.05914089,
        -0.048802186,
        -0.066844024,
        0.01243879,
        0.063333794,
        -0.07279092,
        0.08197471,
        0.037653312,
        -0.009737673,
        -0.00500036,
        0.011661643,
        0.011145643,
        -0.047162678,
        -0.014049451,
        -0.007861011,
        0.036419433,
        0.0508,
        0.052617416,
        -0.009674061,
        0.043111898,
        -0.028977733,
        0.018251128,
        -0.05529869,
        -0.00871158,
        0.0043337657,
        0.0007541179,
        0.004860474,
        -0.002216638,
        -0.03542874,
        0.05396571,
        0.0034838591,
        0.014089717,
        -0.004800495,
        -0.06466787,
        -0.0025800595,
        -0.002178602,
        0.09206079,
        0.058039714,
        0.010877432,
        -0.02082253,
        -0.065058365,
        0.014796284,
        0.009106143,
        -0.011175787,
        0.100524366,
        0.019417217,
        -0.036742102,
        0.08365422,
        0.0111332135,
        -0.04559215,
        0.066757984,
        -0.01063549,
        -0.024148047,
        -0.11897619,
        -0.013800413,
        0.0194261,
        0.039355014,
        -0.018555475,
        -0.019013187,
        0.01495382,
        0.020740975,
        0.03397263,
        -0.08247108,
        -0.05661249,
        0.013562636,
        0.023375954,
        0.050909046,
        -0.052565433,
        0.031450737,
        -0.024382008,
        -0.0745393,
        0.031244671,
        -0.022045253,
        -0.039008714,
        0.0022133444,
        -0.019923909,
        0.05263862,
        0.0071230074,
        -0.0003922108,
        -0.038253713,
        -0.033694062,
        -0.02788082,
        -0.038799442,
        -0.031301647,
        0.031991336,
        -0.018899886,
        0.0029897406,
        -0.0052293832,
        0.054635335,
        0.025015285,
        -0.017133983,
        0.039201044,
        0.027065035,
        -0.041047215,
        -0.0031869314,
        -0.010891951,
        -0.01574646,
        0.07310773,
        0.02762175,
        0.020007072,
        0.06685714,
        -0.010852071,
        -0.04977542,
        -0.017977957,
        0.036453288,
        -0.039911784,
        0.02011598,
        -0.04018626,
        -0.09396819,
        -0.08646485,
        -0.015443586,
        0.08971582,
        -0.04097176,
        -0.060266364,
        0.050583046,
        -0.0018039175,
        0.020041846,
        0.024941636,
        0.02374421,
        0.04987755,
        0.015138004,
        0.029228,
        -0.008547074,
        0.07518501,
        0.010004746,
        -0.052587304,
        -0.04049064,
        -0.085492335,
        0.059145436,
        0.032112032,
        -0.020763997,
        0.00680109,
        0.02921927,
        -0.008873768,
        -0.02103083,
        0.050941776,
        -0.035954528,
        -0.022317085,
        0.011230542,
        0.0013166546,
        -0.011096228,
        -0.0475518,
        0.049377784,
        -0.044378355,
        0.025608191,
        0.03110613,
        -0.061260697,
        -0.00673483,
        -0.019927457,
        0.011846906,
        0.017410029,
        -0.008776907,
        0.027006542,
        -0.030492365,
        0.026257945,
        -0.026779577,
        0.021426694,
        -0.03235769,
        -0.030532146,
        0.041651916,
        0.055453632,
        -0.052918594,
        0.022046523,
        0.029505733,
        -0.0023933977,
        -0.051769093,
        -0.04193796,
        -0.059869748,
        -0.06861497,
        0.078732245,
        -0.060760748,
        -0.013921435,
        0.025013287,
        -0.051408365,
        -0.045444198,
        -0.04952084,
        -0.07342109,
        0.019051503,
        -0.024573997,
        0.056329485,
        -0.02922003,
        -0.026567964,
        0.030175185,
        -0.037733354,
        0.024139557,
        0.016348347,
        0.10157654,
      ],
    }),
  });
  assert(
    resp.error,
    "Expected error due to no matching face, but got success response",
  );
};

const testCheckInCameraSuccessfully = async () => {
  const client: SupabaseClient = await getServiceRoleClient();

  const locationId = uuidv4();
  const { data: newLocationData, error: newLocationError } = await client
    .from("Locations")
    .upsert({
      Id: locationId,
      Room: "101",
      Level: "1",
      Building: "Main",
      Coords: "POINT(-122.4194 37.7749)",
    });

  assert(
    !newLocationError,
    "Failed to insert new location: " + newLocationError?.message,
  );

  const { data, error } = await client.auth.signUp({
    email: `${uuidv4()}@email.com`,
    password: "example-password",
  });

  if (error) {
    throw new Error("Failed to sign up user: " + error.message);
  }

  const { data: newStudentData, error: newStudentError } = await client
    .from("Students")
    .upsert({ Id: data.user?.id, FirstName: "Test", LastName: "Student" })
    .select()
    .single();

  assert(
    newStudentData,
    "Failed to insert new student: " + newStudentError?.message,
  );

  const { data: newStudentFaceData, error: newStudentFaceError } = await client
    .from("StudentFaces")
    .upsert({
      StudentId: newStudentData.Id,
      Embedding: [
        0.015370391,
        0.04673782,
        -0.0034565898,
        0.0694754,
        0.0075824093,
        0.044474557,
        0.061265454,
        0.058892787,
        0.07838084,
        -0.012321637,
        0.016861992,
        0.047343854,
        0.017343776,
        -0.009124971,
        0.022970889,
        -0.055638436,
        -0.02436105,
        0.057897333,
        0.020997962,
        0.010245317,
        0.03049093,
        0.044412203,
        -0.06683892,
        -0.037825853,
        -0.049988233,
        0.066686824,
        -0.004230242,
        -0.065666236,
        -0.0006887776,
        0.03025016,
        0.0004481783,
        0.022819677,
        -0.06701992,
        0.06118844,
        0.045391213,
        -0.028830804,
        0.018779164,
        0.013967292,
        -0.003735336,
        0.024283417,
        0.041963447,
        0.00072689814,
        0.010254826,
        -0.053579487,
        -0.038135268,
        0.037517905,
        -0.02744934,
        0.053351913,
        0.0010695013,
        0.027572457,
        0.0057204305,
        0.009748938,
        -0.05500403,
        0.023899749,
        0.02303816,
        -0.02560864,
        -0.0012121904,
        -0.0025304945,
        -0.0037370198,
        0.019750575,
        -0.005985853,
        0.04575542,
        -0.009942592,
        0.019537475,
        0.0128305,
        -0.099698976,
        -0.0152818505,
        0.025027536,
        0.046289794,
        0.027946174,
        0.0049382127,
        -0.0042962153,
        0.03278748,
        -0.009145367,
        -0.02748757,
        -0.07498658,
        -0.018122464,
        -0.0029934403,
        -0.13435508,
        0.029086174,
        -0.0609211,
        0.019898994,
        0.024458218,
        0.059909835,
        -0.025318727,
        0.02048945,
        0.009574847,
        -0.009983773,
        -0.09037193,
        -0.0265909,
        -0.08518745,
        0.025683872,
        -0.0100338375,
        -0.032658633,
        0.046789527,
        -0.009677339,
        -0.036006927,
        0.0942272,
        -0.023650568,
        -0.008799161,
        0.0069464887,
        -0.016734513,
        0.02710589,
        -0.035606164,
        0.021006217,
        -0.060153473,
        -0.01720427,
        -0.040969666,
        0.031664386,
        -0.09686126,
        -0.056945454,
        -0.012689651,
        -0.03380855,
        0.026914816,
        0.005145643,
        0.035791263,
        0.008134025,
        -0.0025592276,
        -0.0018034608,
        -0.07937411,
        -0.0140946,
        0.09906838,
        0.018814858,
        0.021747498,
        0.0015895631,
        -0.03115907,
        0.037102066,
        0.0021614619,
        0.044956785,
        0.08141591,
        -0.08052082,
        0.070483394,
        0.025654653,
        0.031383798,
        -0.005550209,
        -0.050450604,
        0.06923034,
        0.026149537,
        -0.017386854,
        0.04218119,
        -0.05790964,
        0.071945205,
        0.004418763,
        -0.03646886,
        0.057135805,
        -0.0010936188,
        -0.017342785,
        0.14321083,
        0.016466456,
        -0.0074309898,
        -0.055227008,
        -0.01175222,
        -0.050766166,
        -0.0293025,
        -0.018141545,
        -0.066129066,
        -0.038472384,
        -0.093886696,
        0.03878851,
        -0.05330265,
        0.038480837,
        -0.08865444,
        0.08670699,
        -0.06087224,
        0.08591876,
        0.026833436,
        -0.015966944,
        0.01313599,
        -0.006204514,
        0.06022664,
        0.07389683,
        -0.03614573,
        -0.09247824,
        0.02229565,
        -0.033581182,
        -0.055897083,
        0.0050881724,
        -0.0348863,
        -0.028548347,
        -0.067004986,
        -0.058763098,
        -0.017273992,
        -0.059150618,
        -0.015143803,
        -0.015219199,
        0.04864835,
        0.05032902,
        -0.028470077,
        -0.05553738,
        0.06851472,
        0.007320495,
        0.09612141,
        0.11301428,
        0.0029937867,
        -0.010542895,
        0.013201339,
        0.07199888,
        0.07056289,
        -0.011575645,
        0.01245934,
        -0.02164876,
        0.055590697,
        -0.00043458323,
        0.025553608,
        -0.021760281,
        -0.030580485,
        0.010059666,
        0.02705234,
        0.007024685,
        0.009764047,
        0.037050486,
        -0.10030068,
        0.046875715,
        -0.038997844,
        -0.019919794,
        0.005105557,
        -0.0024434244,
        0.03252264,
        -0.064712785,
        -0.04673039,
        0.027511654,
        0.028936723,
        -0.05629234,
        -0.029911214,
        0.047880445,
        -0.040596202,
        -0.0067006596,
        0.0300062,
        -0.01621104,
        -0.06883773,
        0.038384207,
        0.01844599,
        -0.02587762,
        -0.037124444,
        0.018366426,
        -0.06558932,
        0.02192199,
        -0.047646016,
        -0.02873003,
        0.103472404,
        0.057247374,
        0.071886174,
        0.05895193,
        -0.054339286,
        -0.0007725659,
        -0.008012987,
        -0.04698019,
        -0.007819211,
        -0.041523304,
        -0.07617229,
        -0.033585183,
        0.036273304,
        -0.013102331,
        0.08750367,
        -0.0067917733,
        -0.035158634,
        -0.033625387,
        0.0049135783,
        0.046523362,
        0.037410375,
        -0.03894267,
        -0.0015925594,
        0.03337342,
        0.008534464,
        0.02748685,
        0.05542533,
        -0.01990983,
        -0.0025641248,
        0.047613457,
        -0.04329751,
        -0.015170682,
        0.05932874,
        0.063876554,
        0.031448934,
        -0.018066857,
        -0.03422281,
        0.023811579,
        0.04413562,
        -0.0258775,
        0.017303599,
        -0.022881266,
        0.013831438,
        -0.011496362,
        0.04526468,
        -0.090034515,
        -0.0046476373,
        0.06538604,
        -0.005943582,
        -0.06276116,
        0.04344264,
        0.044463716,
        0.0007669592,
        -0.008731927,
        -0.06438562,
        -0.01704289,
        -0.026995834,
        -0.005209682,
        -0.00969909,
        -0.029742317,
        0.041935142,
        -0.008609201,
        0.036369525,
        -0.01148427,
        -0.017448314,
        -0.02760109,
        0.043212175,
        0.09187964,
        -0.05130598,
        0.0074238037,
        0.004813528,
        -0.027065363,
        -0.074670464,
        0.059986923,
        0.01671905,
        -0.05597681,
        0.046120595,
        -0.052169118,
        0.044588882,
        -0.007687989,
        0.08542797,
        -0.04310316,
        -0.0025509517,
        0.08849315,
        -0.06330976,
        -0.01744652,
        0.008924169,
        0.019767877,
        -0.033134,
        0.05958996,
        0.038797583,
        0.04625956,
        -0.03587494,
        0.01640769,
        0.053312715,
        0.066824935,
        -0.0152319865,
        0.010920624,
        0.03597136,
        -0.07659622,
        -0.07090781,
        0.068292305,
        -0.014618748,
        0.024392348,
        -0.019587114,
        -0.025745016,
        0.031408552,
        -0.02099053,
        0.02294637,
        0.05998987,
        -0.05782235,
        0.023974502,
        0.010967068,
        0.041921694,
        0.032501236,
        0.016712843,
        -0.026642011,
        -0.0905454,
        -0.026565516,
        0.03978696,
        -0.035470963,
        0.054397512,
        -0.023722311,
        -0.003838283,
        -0.033526193,
        -0.0075739,
        -0.035909023,
        0.035001524,
        -0.021283545,
        -0.08684831,
        -0.0024688952,
        -0.029435106,
        -0.10862112,
        0.07883194,
        -0.049431656,
        0.007474242,
        0.04671627,
        -0.014517726,
        0.07738634,
        0.013273722,
        -0.025976328,
        -0.041045267,
        -0.0021068829,
        0.0055878917,
        0.013214143,
        -0.033469547,
        0.025278972,
        -0.046384122,
        -0.035207238,
        -0.016854897,
        0.061115786,
        -0.011981317,
        -0.0017310955,
        -0.035689082,
        -0.07870556,
        -0.013794116,
        -0.05751055,
        0.035855014,
        0.039310146,
        0.04483994,
        0.0033810376,
        0.0028699357,
        0.024372915,
        0.09329481,
        -0.066907085,
        -0.057393864,
        0.016953813,
        0.037810195,
        0.054068826,
        0.061584134,
        -0.029919336,
        0.009395793,
        -0.027237229,
        -0.009230158,
        -0.0019240093,
        0.07341214,
        -0.0110119,
        0.021291925,
        -0.008394648,
        -0.049584568,
        -0.021803437,
        0.0105390195,
        0.052726906,
        -0.020503394,
        -0.15735671,
        -0.050761387,
        -0.0055030747,
        -0.04995752,
        -0.055258043,
        0.0044664107,
        0.045905408,
        -0.04398764,
        0.016750092,
        0.062962696,
        0.0038449592,
        0.055441726,
        -0.027341034,
        -0.035607647,
        0.01459682,
        -0.0040666373,
        -0.023339119,
        0.051920075,
        -0.03108521,
        0.012226195,
        0.10221232,
        0.0007518471,
        0.038844552,
        0.013090194,
        0.021742685,
        0.040600512,
        0.010492383,
        0.03148292,
        0.017119184,
        -0.07834622,
        -0.040290248,
        -0.024243118,
        0.07801629,
        0.0024214166,
        -0.052591667,
        0.03908138,
        0.021976745,
        -0.0687566,
        0.008584308,
        -0.0027802303,
        0.05293164,
        -0.090203,
        -0.10510012,
        -0.044049166,
        -0.013051936,
        -0.01483035,
        0.00051049027,
        0.021912264,
        0.05466683,
        -0.010130697,
        0.022018943,
        -0.05214429,
        0.02103007,
        -0.017370079,
        -0.08133655,
        0.033888854,
        -0.013295402,
        0.020124927,
        0.044402815,
        -0.044759583,
        0.06474775,
        -0.04317014,
        0.015612014,
        0.05501353,
        0.07632238,
        0.054445818,
        -0.057673015,
        -0.02933896,
        0.014898802,
        -0.02051375,
        -0.056286633,
        0.018296372,
        -0.027331427,
        0.054446783,
        -0.032825883,
        -0.033039827,
        -0.023118204,
        0.0248108,
        -0.043197364,
        -0.017184546,
        0.023485195,
        0.010862649,
        0.061567012,
        -0.056582652,
        -0.003610085,
        -0.055173397,
        0.054967128,
        -0.015258594,
        0.0014221359,
      ],
    });

  assert(
    !newStudentFaceError,
    "Failed to insert new student face: " + newStudentFaceError?.message,
  );

  const { data: newCameraData, error: newCameraError } = await client
    .from("Cameras")
    .insert({ Name: "Test Camera", Location: locationId, IsActive: true })
    .select()
    .single();

  assert(
    !newCameraError,
    "Failed to insert new camera: " + newCameraError?.message,
  );

  const create_key_resp = await client.functions.invoke(
    "create-camera-api-key",
    {
      method: "POST",
      body: JSON.stringify({
        CameraId: newCameraData.Id,
        Primary: true,
      }),
    },
  );

  assert(
    !create_key_resp.error,
    "Failed to create camera API key: " + JSON.stringify(create_key_resp.error),
  );
  const key: string = await create_key_resp.data.Key;

  assert(key.length > 0, "No API key returned from create-camera-api-key");

  const anonClient: SupabaseClient = await getAnonClient();

  const resp = await anonClient.functions.invoke("camera-check-in", {
    method: "POST",
    headers: {
      "apikey": key,
    },
    body: JSON.stringify({
      Embedding: [
        0.048045352,
        0.027072774,
        -0.0012431786,
        0.080227666,
        0.0045750723,
        0.072443314,
        0.037117947,
        0.020406729,
        0.009323587,
        -0.005323765,
        0.039810997,
        0.022502424,
        0.03988811,
        0.03236724,
        0.007876664,
        -0.008007562,
        -0.0071229,
        0.07643772,
        -0.05312926,
        -0.022046873,
        0.051476594,
        0.05392697,
        -0.059077308,
        -0.07303337,
        -0.07057642,
        0.055879954,
        -0.028608285,
        -0.09668907,
        -0.059958108,
        0.026250284,
        -0.0075675384,
        0.013863647,
        -0.0015649607,
        0.068842836,
        0.021292288,
        0.030383782,
        0.015302743,
        0.01752986,
        0.008184098,
        0.066250876,
        0.040489774,
        -0.01369929,
        -0.022881232,
        -0.069894336,
        0.021784822,
        0.03377963,
        -0.06741719,
        0.04028889,
        -0.02425391,
        -0.04055527,
        -0.042420924,
        2.9476096E-05,
        -0.089948416,
        0.013145041,
        -0.011440969,
        -0.039752193,
        -0.016501186,
        0.028865417,
        -0.0077231247,
        0.03953363,
        -0.014598216,
        0.035658177,
        0.004644994,
        -0.037256677,
        0.0202987,
        -0.0264444,
        -0.0011093384,
        0.013936846,
        0.04410766,
        0.07033884,
        -0.018084686,
        -0.032034297,
        0.0123275425,
        0.0007799352,
        -0.03799335,
        -0.046589084,
        0.024604063,
        -0.02458864,
        -0.07680105,
        -0.009307664,
        -0.030667186,
        -0.021075778,
        -0.0005742425,
        0.023451596,
        -0.008012989,
        0.06542488,
        -0.03107563,
        0.021800397,
        -0.08768012,
        -0.007327407,
        -0.05512437,
        0.042426143,
        0.06417047,
        -0.04116748,
        -0.0006596534,
        -0.012792979,
        -0.12158879,
        0.1019875,
        -0.016001515,
        -0.027941747,
        -0.044866413,
        0.019524084,
        -0.016137267,
        -0.02580343,
        0.0076408023,
        -0.040856164,
        0.034299463,
        -0.011466531,
        0.041199524,
        -0.10669405,
        -0.01912531,
        -0.036837082,
        -0.046012696,
        -0.0061863083,
        0.0011708931,
        0.017925398,
        0.008190889,
        -0.0052674864,
        0.008044577,
        -0.045482572,
        0.015808977,
        0.080728725,
        0.004336514,
        -0.001382253,
        -0.030532986,
        0.040113863,
        0.007939908,
        -0.025775716,
        0.01809969,
        0.02553204,
        -0.06247805,
        0.0009778753,
        0.0039349184,
        -0.01540094,
        -0.04619087,
        -0.03144018,
        0.031206595,
        -0.017289246,
        -0.050831873,
        0.06481111,
        -0.058465037,
        0.05862662,
        0.008269155,
        -0.06502778,
        0.021362996,
        -0.045981836,
        -0.0063954224,
        0.0960436,
        -0.037002187,
        -0.0013264191,
        -0.029119559,
        -0.028045913,
        -0.077899754,
        0.021018395,
        -0.0038106164,
        -0.07302975,
        -0.0018904977,
        -0.06356732,
        -0.008553648,
        -0.06666742,
        0.009793893,
        -0.11539978,
        0.05079132,
        0.017967252,
        0.07936568,
        -0.0150128715,
        0.001611127,
        0.061574023,
        0.0012681326,
        0.00979411,
        0.05244959,
        -0.029454388,
        -0.042035203,
        0.03363656,
        -0.03347431,
        -0.029819926,
        0.001004583,
        -0.013805669,
        -0.010851555,
        -0.018309299,
        -0.036579415,
        0.0035233293,
        -0.06388491,
        0.026233554,
        0.021205844,
        0.027441263,
        0.031270955,
        0.0055890316,
        -0.03881229,
        0.026382778,
        0.023919811,
        0.07513106,
        0.09852587,
        0.04632909,
        0.027252296,
        0.0028269743,
        0.1103735,
        0.09995589,
        -0.026491722,
        0.019559138,
        0.0044716736,
        0.039020564,
        0.006108971,
        0.006590134,
        -0.06027021,
        -0.0154297585,
        -0.039821375,
        -0.0051426804,
        0.05386077,
        0.06561884,
        0.033417694,
        -0.04367976,
        0.026903287,
        -0.02712955,
        -0.04935603,
        -0.013768624,
        0.0073661366,
        0.034279123,
        -0.06045725,
        -0.072791874,
        0.030312907,
        0.014027977,
        -0.06147309,
        0.05694131,
        0.03743827,
        -0.042673916,
        0.029508762,
        -0.01988494,
        0.0040807035,
        -0.07289797,
        -0.010800931,
        -0.038535945,
        -0.028782252,
        -0.031806875,
        0.047818232,
        -0.06278436,
        0.056266293,
        -0.038825728,
        0.0049038134,
        0.09210871,
        -0.008341436,
        0.05237038,
        0.051284052,
        -0.13174796,
        0.0327498,
        -0.07108229,
        0.003945274,
        0.013955389,
        -0.06540016,
        -0.13344175,
        0.032934982,
        0.057482656,
        0.006220428,
        0.064991936,
        -0.0039103245,
        0.00552471,
        -0.014609527,
        0.06284885,
        0.034706127,
        0.05922091,
        -0.07558267,
        -0.017286645,
        0.0004899152,
        -0.013191811,
        0.06718604,
        0.01843285,
        -0.0068148663,
        -0.014793524,
        0.005922245,
        -0.02258099,
        0.0016823438,
        0.041744348,
        0.017709078,
        0.02884698,
        0.0041986317,
        -0.0140730385,
        0.00967482,
        0.065648995,
        -0.07109188,
        0.028738063,
        -0.03302074,
        0.044131227,
        -0.017240077,
        0.06029109,
        -0.092388265,
        -0.05478659,
        0.05960011,
        -0.022208292,
        -0.020902043,
        0.027687322,
        0.026858116,
        -0.049049348,
        -0.027527845,
        -0.038105402,
        -0.010679041,
        0.06556396,
        -0.01829763,
        -0.04316302,
        -0.08879943,
        0.07679465,
        -0.0101409685,
        1.9315623E-06,
        -0.0011443867,
        -0.038143102,
        -0.022491543,
        -0.006434084,
        0.04946139,
        -0.04817906,
        -0.013069233,
        -0.042964544,
        -0.08311414,
        -0.057663362,
        0.055212885,
        0.062241834,
        -0.0066377968,
        0.03599472,
        -0.052053567,
        0.030024508,
        0.0062210998,
        0.03781574,
        -0.030306986,
        0.061354537,
        0.052685287,
        -0.005939893,
        -0.047475874,
        0.026232913,
        -0.014340517,
        -0.039811686,
        0.032986674,
        0.012971128,
        0.05665038,
        0.041327897,
        0.041942645,
        0.041825287,
        0.056084882,
        -0.017042128,
        -0.01865739,
        0.04202105,
        -0.08444011,
        0.008509951,
        0.05405967,
        0.005741277,
        0.03216456,
        0.010497314,
        -0.0038671864,
        -0.0041995198,
        0.039358445,
        0.03776227,
        0.009585298,
        -0.04233873,
        0.001990058,
        0.0009476859,
        0.030950008,
        0.015224764,
        0.005483475,
        0.039479863,
        -0.11598806,
        -0.064698204,
        0.046626393,
        -0.02404219,
        0.052446723,
        -0.032510247,
        0.02081808,
        -0.011597651,
        -0.014060662,
        -0.08538625,
        0.015738657,
        -0.058409683,
        -0.0723938,
        0.006026121,
        0.03131281,
        -0.066472396,
        0.056381818,
        -0.08178112,
        0.020285971,
        0.07223171,
        0.027296042,
        0.04451994,
        0.06444247,
        -0.03820538,
        -0.0011352857,
        0.0062573454,
        0.03309601,
        -0.02749446,
        -0.014508099,
        -0.0021201123,
        -0.06643446,
        -0.027078306,
        0.0037709754,
        0.013428763,
        0.015386065,
        -0.0076489844,
        0.0019746656,
        -0.046401996,
        0.014748185,
        -0.026514953,
        -0.017378667,
        0.022348898,
        -0.01229116,
        0.10968508,
        -0.06791365,
        -0.043334678,
        0.08726961,
        -0.065384306,
        -0.081367165,
        -0.0050615775,
        0.10127824,
        0.11786041,
        0.065666586,
        -0.04653027,
        0.025211062,
        -0.07922099,
        0.03552322,
        -0.030160652,
        0.042100213,
        0.00044460513,
        -0.054198064,
        -0.003607536,
        -0.037254028,
        -0.03869469,
        -0.0025282307,
        -0.0034455014,
        -0.059132934,
        -0.11411418,
        -0.091586724,
        0.0034153773,
        -0.023196373,
        -0.08136929,
        0.018326404,
        0.0057704016,
        -0.052280903,
        0.0074208826,
        0.06389013,
        -0.0111429915,
        -0.0048985784,
        -0.011241751,
        -0.04801633,
        0.019835653,
        -0.042548157,
        -0.004894831,
        0.023084873,
        0.005823182,
        0.017711617,
        0.0502248,
        -0.03924526,
        0.06328769,
        -0.07131152,
        -0.0076468065,
        -0.0062354864,
        0.015170739,
        -0.037212815,
        -0.0036277948,
        -0.036828462,
        -0.009487584,
        -0.04678729,
        0.04651275,
        0.0369243,
        -0.028316213,
        0.012806276,
        0.017908383,
        -0.016265132,
        -0.0043033455,
        -0.022680523,
        0.07552527,
        -0.075083114,
        -0.059033003,
        -0.021763407,
        -0.007462202,
        -0.06627498,
        -0.0060817464,
        0.020985877,
        0.0007581957,
        0.005929141,
        0.02740248,
        -0.05348708,
        0.0059103244,
        -0.0061896006,
        -0.09781796,
        -0.00040342085,
        -0.046893433,
        -0.063664585,
        -0.029340712,
        -0.010437165,
        0.020783994,
        -0.020930367,
        0.060050275,
        0.047983434,
        0.081186235,
        0.04597308,
        -0.03437774,
        0.008139092,
        -0.007347483,
        -0.018342733,
        -0.075662576,
        -0.019157175,
        -0.06365367,
        0.016190205,
        -0.0028397103,
        -0.031580962,
        -0.01387715,
        0.0043030647,
        -0.0384519,
        -0.0012134955,
        0.009535361,
        0.019970426,
        0.08446488,
        -0.09278915,
        -0.055768736,
        -0.041809883,
        0.05765124,
        -0.007588715,
        0.012542295,
      ],
    }),
  });
  assert(!resp.error, "Camera check-in failed: " + JSON.stringify(resp.error));
  console.log("Camera check-in response:", resp.data);
  assert(
    resp.data.studentId === newStudentData.Id,
    "Camera check-in returned wrong student ID: " + resp.data.StudentId,
  );
};

Deno.test(
  "Missing CameraApiKey",
  { sanitizeResources: false },
  testCheckInCameraWithBadApiKey,
);
Deno.test(
  "Unauthorized Camera Check-In Test",
  { sanitizeResources: false },
  testCheckInCameraWithMissingApiKey,
);
Deno.test(
  "Successful Camera Check-In Test",
  { sanitizeResources: false },
  testCheckInCameraSuccessfully,
);
